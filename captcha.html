<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Проверка безопасности</title>
    <link rel="stylesheet" type="text/css" href="./style.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
</head>
<body>
    <div class="container">
        <h1>Проверка безопасности</h1>
        <p>Для продолжения общения в чате, пожалуйста, пройдите проверку ниже</p>
        <div class="g-recaptcha" data-sitekey="6LeIxAcTAAAAAJcZVRqyHh71UMIEGNQ_MXjiZKhI" data-callback="onSubmit"></div>
        <div id="error-message" style="color: red; margin-top: 10px; display: none;">
            Доступ разрешен только с территории России
        </div>
    </div>
    <script>
        var WebApp = window.Telegram.WebApp;
        var ip;
        
        function isRussianIP(ip) {
            return new Promise((resolve, reject) => {
                $.getJSON('http://ip-api.com/json/' + ip, function(data) {
                    resolve(data.countryCode === 'RU');
                }).fail(function() {
                    reject(new Error('Не удалось проверить регион'));
                });
            });
        }

        $.getJSON('https://api.ipify.org?format=jsonp&callback=?', function(data) {
            ip = data['ip'];
        });

        WebApp.expand();
        
        async function onSubmit(token) {
            try {
                const isRussian = await isRussianIP(ip);
                if (isRussian) {
                    setTimeout(() => { 
                        WebApp.sendData('success|' + ip + '|' + navigator.userAgent);
                    }, 3000);
                } else {
                    document.getElementById('error-message').style.display = 'block';
                    setTimeout(() => {
                        WebApp.close();
                    }, 3000);
                }
            } catch (error) {
                console.error('Ошибка при проверке IP:', error);
                WebApp.close();
            }
        }
    </script>
</body>
</html>
