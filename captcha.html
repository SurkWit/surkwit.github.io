<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Проверка безопасности</title>
    <link rel="stylesheet" type="text/css" href="./style.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
</head>
<body>
    <div class="container">
        <h1>Проверка безопасности</h1>
        <p>Для продолжения общения в чате, пожалуйста, пройдите проверку ниже</p>
        <div class="g-recaptcha" data-sitekey="6LdScDcrAAAAAKqDN9uAhjozK-QIBIxVeoHeNcpa" data-callback="onSubmit"></div>
        <div id="error-message" style="color: red; margin-top: 10px; display: none;"></div>
        <div id="loading" style="display: none; margin-top: 10px;">
            Пожалуйста, подождите...
        </div>
    </div>
    <script>
        var WebApp = window.Telegram.WebApp;
        var ip;
        
        function showError(message) {
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-message').style.display = 'block';
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // Get verification token from URL
        function getVerificationToken() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            if (!token) {
                showError('Ошибка: отсутствует токен верификации');
                return null;
            }
            return token;
        }

        // Use a proxy to get around CORS issues with whatismyipaddress.com
        function getIPInfo() {
            return new Promise((resolve, reject) => {
                const userIP = ""; // Will be filled by the server that handles the proxy
                
                $.ajax({
                    url: 'https://extreme-ip-lookup.com/json/',
                    dataType: 'json',
                    success: function(data) {
                        ip = data.query || data.ip;
                        resolve({
                            ip: ip,
                            country: data.countryCode
                        });
                    },
                    error: function(xhr, status, error) {
                        // Fallback to ipapi.co if the first service fails
                        $.getJSON('https://ipapi.co/json/', function(backupData) {
                            ip = backupData.ip;
                            resolve({
                                ip: backupData.ip,
                                country: backupData.country_code
                            });
                        }).fail(function() {
                            reject(new Error('Не удалось определить IP адрес'));
                        });
                    }
                });
            });
        }
        
        function isRussianIP(ipInfo) {
            return ipInfo.country === 'RU';
        }

        // Preload IP information
        getIPInfo().catch(error => {
            showError('Не удалось определить IP адрес: ' + error.message);
        });

        WebApp.expand();
        
        async function onSubmit(recaptchaToken) {
            if (!recaptchaToken) {
                showError('Пожалуйста, пройдите капчу');
                return;
            }

            const verificationToken = getVerificationToken();
            if (!verificationToken) {
                return;
            }

            showLoading(true);
            showError('');

            try {
                const ipInfo = await getIPInfo();
                if (isRussianIP(ipInfo)) {
                    WebApp.sendData(`success_${verificationToken}_${ipInfo.ip}_${navigator.userAgent}`);
                    showLoading(false);
                } else {
                    showError('Доступ разрешен только с территории России');
                    setTimeout(() => {
                        WebApp.close();
                    }, 3000);
                }
            } catch (error) {
                console.error('Ошибка при проверке IP:', error);
                showError('Произошла ошибка при проверке региона: ' + error.message);
                showLoading(false);
            }
        }
    </script>
</body>
</html>
