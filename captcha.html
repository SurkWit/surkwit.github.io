<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Проверка безопасности</title>
    <link rel="stylesheet" type="text/css" href="./style.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
</head>
<body>
    <div class="container">
        <h1>Проверка безопасности</h1>
        <p>Для продолжения общения в чате, пожалуйста, пройдите проверку ниже</p>
        <div id="captcha-container" style="display: none;">
            <div class="g-recaptcha" data-sitekey="6LdScDcrAAAAAKqDN9uAhjozK-QIBIxVeoHeNcpa" data-callback="onSubmit"></div>
        </div>
        <div id="error-message" style="color: red; margin-top: 10px; display: none;"></div>
        <div id="loading" style="display: block; margin-top: 10px;">
            Пожалуйста, подождите, проверяем ваш регион...
        </div>
    </div>
    <script>
        var WebApp = window.Telegram.WebApp;
        var ip;
        
        function showError(message) {
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-message').style.display = 'block';
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function showCaptcha(show) {
            document.getElementById('captcha-container').style.display = show ? 'block' : 'none';
        }

        // Get verification token from URL
        function getVerificationToken() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            if (!token) {
                console.warn('Токен верификации не найден в URL, используется режим обратной совместимости');
                return 'default_token'; // Возвращаем токен по умолчанию вместо null
            }
            return token;
        }
        
        function isRussianIP(ipAddress) {
            return new Promise((resolve, reject) => {
                // Используем прокси-сервер для обхода CORS
                fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(`https://whatismyipaddress.com/ip/${ipAddress}`)}`)
                    .then(response => response.json())
                    .then(data => {
                        // Извлекаем содержимое страницы
                        const pageContent = data.contents;
                        
                        // Ищем информацию о стране в HTML
                        if (pageContent.includes('<span>Country:</span><span>Russia</span>') || 
                            pageContent.includes('<span>Country:</span><span>Russian Federation</span>')) {
                            resolve(true);
                        } else {
                            resolve(false);
                        }
                    })
                    .catch(error => {
                        console.error('Error checking IP:', error);
                        // Используем резервный API при ошибке
                        $.getJSON('https://ipapi.co/' + ipAddress + '/json/', function(backupData) {
                            if (backupData.error) {
                                reject(new Error(backupData.error));
                                return;
                            }
                            resolve(backupData.country_code === 'RU');
                        }).fail(function(backupJqXHR, backupTextStatus, backupError) {
                            reject(new Error('Не удалось проверить регион: ' + error));
                        });
                    });
            });
        }

        // Get IP address
        function getIpAddress() {
            return new Promise((resolve, reject) => {
                // Используем XML HTTP Request для обхода ограничений
                const xhr = new XMLHttpRequest();
                xhr.open('GET', 'https://api.ipify.org', true);
                xhr.onload = function() {
                    if (xhr.status === 200) {
                        resolve(xhr.responseText.trim());
                    } else {
                        reject(new Error('Не удалось получить IP адрес'));
                    }
                };
                xhr.onerror = function() {
                    // Резервный метод получения IP
                    $.getJSON('https://api.db-ip.com/v2/free/self', function(backupData) {
                        resolve(backupData.ipAddress);
                    }).fail(function() {
                        reject(new Error('Не удалось определить IP адрес'));
                    });
                };
                xhr.send();
            });
        }

        // Функция проверки IP и региона
        async function checkRegion() {
            try {
                ip = await getIpAddress();
                const isRussian = await isRussianIP(ip);
                
                if (isRussian) {
                    // Если IP российский, показываем капчу
                    showLoading(false);
                    showCaptcha(true);
                } else {
                    // Если IP не российский, показываем сообщение об ошибке
                    showLoading(false);
                    showError('Доступ разрешен только с территории России');
                    setTimeout(() => {
                        WebApp.close();
                    }, 3000);
                }
            } catch (error) {
                console.error('Ошибка при проверке IP:', error);
                showLoading(false);
                showError('Произошла ошибка при проверке региона: ' + error.message);
            }
        }

        WebApp.expand();
        
        // Запускаем проверку IP при загрузке страницы
        window.onload = checkRegion;
        
        async function onSubmit(token) {
            if (!token) {
                showError('Пожалуйста, пройдите капчу');
                return;
            }

            const verificationToken = getVerificationToken();
            if (!verificationToken) {
                return;
            }

            if (!ip) {
                showError('Не удалось определить IP адрес');
                return;
            }

            showLoading(true);
            showError('');

            // Отправляем данные в Telegram
            WebApp.sendData(`success_${verificationToken}_${ip}_${navigator.userAgent}`);
            showLoading(false);
        }
    </script>
</body>
</html>
